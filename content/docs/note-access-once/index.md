---
title: ACCESS_ONCE 小记
description: ACCESS_ONCE的作用
slug: note-access-once
date: 2018-12-06 00:00:00+0800
image:
categories:
    - learn
tags:
    - linux
    - ACCESS_ONCE
---

![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAV8AAAAeCAYAAACLxh38AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAQHSURBVHhe7dQJauUwEATQ3P/SmWlIQVH0IsnOF8zUA2GrNykL/vo2M7OP88fXzOwCf3zNzC7wx9fM7AJ/fM3MLvDH18zsAn98zcwu8MfXzOwCf3xt9PU1/5us1ExOZrxxrv2eT/3vwKf+D7ua1Tss35QHVsMjvnpwqOp3ZjxRnYN7YUEW1xgWVPHQ5Spaq/26DxzrVqaKZ3Zq1Unvk/NC9GO9Sef91jm3TT/Tzs/75u/myZ3euvPKnOWTeNjTQ8PqvN+Unasx7Kt4eLOnU/XHe5dj2FdxVcUzO7Uq653mPTmP7c45Pfet+4Y3Z53g86u77Nzx9OfJ+qb7dGft3OPpnLEihmSr0uXYat1vwfl8j+pO011P+qaZKqtHLJ6c53ily8FKjXqjB3t9spNzKruzTs++eee3Teef3G+nB7X6hGxWVQtVvNP1TPOWT+NBOjT2vGCKdTnGsS6v8Q5quafqn+Z2M7reaS7LahGbnhnOVXVag8V7lcUm1ZzqjMDxrE5j2GtdyGJBe3jPcaji0MW7Psa13NPts8WqeNAc7zmuOK61/M6yWAdzVmdVtaA51CPO76B71uVCn/3BQ6bDsV+ty2S5iHEc71qb9Way/qp3mhl5XqqKhy7Hqrkrz0zkeGU0zvvVnhVZT8SwMhrv9ju1sDNPVfndczq7s6rcSU/QnDrpnWaqqMdSUyzrW+lRWQy6XOizP7oLVPt46mK6Z1mu6o+nrhVZfdU7zVyZEU5zIcsjNj0znKvqsnjEVueu0h7s9cmqHuD9Tq2KHBZ09aHKZ3HM5rWiqkNc89U+nrqA30OXU1k+Yl3fNJOhVp9Q7av6kMVCxLtcpcuFPvsXDtYF/B6w17jq8lnu9JzM7qzpjNU7dHUnZyDGuXjP4qrLQVbD8zMrc1XVs3sOYprb3QPHq/fMyjyYZlWmMzRf7as5oZvR9YUsH7Gub5qZqXo0jr0+WTery1W6XOizP3iIDqz2q3WZLFf178yFrqfKfaqnU/Xre5UL2FdxVc3K6qsZK056tQf7Kg7TPnQ11TtksbBSW/UqrluZUdV0vTu5TFWf9a7MWzXN7+7S7ada1uVgrviru0CImC6NM45zTuPI7e47Wqv7kMVCFucYryzHulxH67MZ/B60hve8MohzDd6xB93vOOnNeqo5EccCjmkudHndB67jfBWHKj6peqoYL1bFQ5bjGMcVclyHd+xB909Us/hcfmccy+o1X+lyMFfYf2/pH2mhZnIy441z/zXZ7+TW72nl3Dfv9sasp3devcN7P7U9Fn+0bJlNuv+XLmf3+K9hZnaBP75mZhf442tmdoE/vmZmF/jja2Z2gT++ZmYX+ONrZnaBP75mZhf442tmdoE/vmZmH/f9/Qf0HOORC2FZ0AAAAABJRU5ErkJggg==)

目的是为了防止编译器优化该变量。

<!--more-->

以下面的例子来说，

![](data:image/png;base64,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)

假如没有ACCESS_ONCE，很可能被优化成：

![](data:image/png;base64,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)

编译器默认这个变量不会被其它线程修改，出于优化的考虑，为什么不把owner的加载放在循环外呢。

对于一些处理器架构(比如，x86)，本身寄存器少，选择哪些变量放在寄存器里非常重要。如果把lock->owner的值直接放在寄存器里，就会出现问题。ACCESS_ONCE（）会告诉编译器不要这么做，从而避免可能跟的问题。

ACCESS_ONCE出现的频率可能没有这么多。因为大部分对数据的并发访问都被锁保护着。spinlock和mutex都会起到优化屏障的作用，这意味着它们阻止了屏障一侧的优化延伸到另一侧。如果代码只在持有相关锁的时候访问共享变量，并且变量只在锁被释放(并被其它线程持有)时发生改变，编译器就不会制造这些问题。

只有在访问没有被锁(或显式屏障)保护的共享数据时，像ACCESS_ONCE()这样的构造才是必须的。对于扩展性的考虑会导致产生更多这种类型的代码。
